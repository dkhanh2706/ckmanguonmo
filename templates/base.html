<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Yuki Meal Planner{% endblock %}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- CSS chung -->
    <link rel="stylesheet" href="/static/css/style.css" />
    <!-- CSS cho trang công thức (nếu không dùng vẫn không sao) -->
    <link rel="stylesheet" href="/static/css/recipes.css" />

    {% block head_extra %}{% endblock %}
  </head>

  <body>
    <div class="bg-overlay"></div>

    <!-- ================= NAVBAR ================= -->
    <header class="header">
      <!-- Logo -->
      <a href="/" class="logo">
        <div class="logo-mark">雪</div>
        <span class="logo-text">Yuki Meal Planner</span>
      </a>

      <!-- Menu, sẽ được JS thay đổi nếu user đã đăng nhập -->
      <nav class="nav" id="main-nav">
        <!-- Menu mặc định khi CHƯA đăng nhập -->
        <a href="/" class="nav-link">
          <i class="fas fa-home"></i> Trang chủ
        </a>
        <a href="/meal-planner" class="nav-link">
          <i class="fas fa-calendar-alt"></i> Lịch ăn uống
        </a>
        <a href="/recipes" class="nav-link">
          <i class="fas fa-book"></i> Công thức
        </a>
        <a href="/shopping-list" class="nav-link">
          <i class="fas fa-shopping-cart"></i> Mua sắm
        </a>
        <a href="/login" class="nav-link">
          <i class="fas fa-sign-in-alt"></i> Đăng nhập
        </a>
        <a href="/register" class="nav-link">
          <i class="fas fa-user-plus"></i> Đăng ký
        </a>
      </nav>
    </header>

    <!-- ================ MAIN CONTENT ================ -->
    <main class="main">
      {% block content %}{% endblock %}
    </main>

    <!-- ================ FOOTER ================ -->
    <footer class="footer">
      <p>
        Made with
        <i class="fas fa-heart" style="color: #ef4444"></i>
        &
        <i class="fas fa-mug-hot" style="color: #7c3aed"></i>
        in Japan style
      </p>
      <p style="font-size: 12px; color: #9ca3af">
        Yuki Meal Planner – Simple Recipe & Meal Planning Demo
      </p>
    </footer>

    <!-- JS chung -->
    <script src="/static/js/main.js"></script>

    <!-- Dynamic Navigation Script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const userJson = localStorage.getItem("user");
        const navElement = document.getElementById("main-nav");

        // ========== 1. Nếu có user trong localStorage -> đổi menu ==========
        if (userJson && navElement) {
          try {
            const user = JSON.parse(userJson);
            const displayName =
              (user.full_name && user.full_name.trim()) ||
              user.email ||
              "Bạn";

            navElement.innerHTML = `
              <span class="nav-hello">
                  <i class="fas fa-user-circle"></i> ${displayName}
              </span>
              <a href="/" class="nav-link">
                  <i class="fas fa-home"></i> Trang chủ
              </a>
              <a href="/meal-planner" class="nav-link">
                  <i class="fas fa-calendar-alt"></i> Lịch ăn uống
              </a>
              <a href="/recipes" class="nav-link">
                  <i class="fas fa-book"></i> Công thức
              </a>
              <a href="/shopping-list" class="nav-link">
                  <i class="fas fa-shopping-cart"></i> Mua sắm
              </a>
              <a href="#" id="logoutBtn" class="nav-link">
                  <i class="fas fa-sign-out-alt"></i> Đăng xuất
              </a>
            `;

            // Xử lý logout
            const logoutBtn = document.getElementById("logoutBtn");
            if (logoutBtn) {
              logoutBtn.addEventListener("click", function (e) {
                e.preventDefault();
                localStorage.removeItem("user");
                window.location.href = "/";
              });
            }
          } catch (e) {
            console.error("Lỗi khi parse user data:", e);
          }
        }

        // ========== 2. Thêm hiệu ứng ACTIVE cho nav-link hiện tại ==========
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll(".nav-link");

         navLinks.forEach((link) => {
          const href = link.getAttribute("href");
          if (!href) return;

          if (href === currentPath) {
            link.classList.add("nav-link-active");
          }
        });
      });
    </script>

    {% block scripts %}{% endblock %}
  </body>
</html>
